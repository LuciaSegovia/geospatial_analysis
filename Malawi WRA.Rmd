---
title: "Cleaning and exporting Malawi WRA"
author: "Fanny Sandalinas"
date: "02/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


.libPaths('C:/Users/FannySandalinas/Documents/R/win-library/4.0')

library(haven)
library(tidyverse)
library(dplyr)
library(survey)
source('macro_wra.R')
library(matrixStats)
library(gt)
library(formattable)
library(kableExtra)
library(gtsummary)


###---Cleaning the dataset----

#check nrows and nvariables are expected
#if women, all women, age, not pregnant, clumping, distribution, plausible numbers for biomarkers, negative values, dates and time in correct format, unique IDs. when you merge data, you don't lose or duplicates
#units


Malawi_WRA <- read_sav("C:/Users/FannySandalinas/Documents/WP2/biomarkers/Datasets/Malawi 2015/MWOB7ASV/MW_WRA.SAV")


# renaming variables 

Malawi_WRA<-Malawi_WRA %>% rename(
  ferritin='Fer',
  region='MREGION',
  rbp='RBP',
  crp='CRP',
  agp='AGP',
  stfr='sTfR',
  zinc='Zn_gdl',
  dretinol='incap_dr',
  retinol='incap_retinol',
  urbanity='MTYPE',
  MRDR='MRDR_ratio',
  survey_cluster1='MCLUSTER',
  household_id1='MNUMBER',
  LINENUMBER='M01',
  AGE_IN_YEARS='M07',
  SALT_PRESENT='M102',
  SALT_LABEL_IODIZED='M104',
  OIL_PRESENT='M110',
  OIL_FORTIFIED='M112',
  IRON_LWEEK='M414',
  ANY_IRON='M415',
  FEVER24='M417',
  HEMOGLOBIN_LAB='M432',
  Malaria_test_result='M431',
  WEIGHT='M435',
  HEIGHT='M436',
  is_pregnant='preg',
  agp_HIGH='agp_c1',
  crp_HIGH='crp_c1',
  ANY_INFLAMMATION='agp_crp_c1',
  ANEMIA_ADJUSTED='anemia',
  SFER_microg_L_ADJUSTED_INTERNAL='sf_reg',
  LOW_SFER_microg_L_UNADJUSTED='sf_c2',
  LOW_SFER_microg_L_ADJUSTED='sf_c1',
  VITA_CONTENT_OIL='oil_vitA',
  VITA_CONTENT_SUGAR='SUGAR_VITA',
  IODINE_SALT='salt',
  was_fasting='fast',
  ps_folate='FOL',
  rbc_folate='RBCF',
  iodine='IOD',
  selenium='SEL',
  vitamin_b12_gr='VITB12')
  
Malawi_WRA$age_in_months<-Malawi_WRA$AGE_IN_YEARS*12

#creating BMI groups

Malawi_WRA$HEIGHT_METERS<- Malawi_WRA$HEIGHT/100

Malawi_WRA$BMI<- Malawi_WRA$WEIGHT/Malawi_WRA$HEIGHT_METERS^2


#description of the sample


# looking at variables of interest: summary stats + histogram

hist(Malawi_WRA$ferritin)
summary(Malawi_WRA$ferritin)

hist(Malawi_WRA$stfr)
summary(Malawi_WRA$stfr)

summary(Malawi_WRA$rbp)
hist(Malawi_WRA$rbp)

summary(Malawi_WRA$crp)
hist(Malawi_WRA$crp)

summary(Malawi_WRA$agp)
hist(Malawi_WRA$agp)

#example of histogram
hist(Malawi_WRA$zinc,
     main='Histogram of serum zinc in Malawi MNS 2015',
     xlab='Serum Zinc in migrog/dL')
abline(v=60, col='blue')
abline(v=161, col='red')
text(90,320, 'Deficiency threshold', col='blue')
text(215,20,'Threshold to define abnormal values', col = 'red')

hist(Malawi_WRA$retinol)

summary(Malawi_WRA$MRDR)
hist(Malawi_WRA$MRDR)

summary(Malawi_WRA$AGE_IN_YEARS)
hist(Malawi_WRA$AGE_IN_YEARS)

summary(Malawi_WRA$selenium)
hist(Malawi_WRA$selenium)

summary(Malawi_WRA$ps_folate)
hist(Malawi_WRA$ps_folate)

summary(Malawi_WRA$rbc_folate)
hist(Malawi_WRA$rbc_folate)

hist(Malawi_WRA$HEIGHT_METERS)
hist(Malawi_WRA$HEIGHT)
hist(Malawi_WRA$WEIGHT)

#creating a variable to define eligible women based on age (15-49) and being non-pregnant

Malawi_WRA<-rename(Malawi_WRA, sex=M04)
Malawi_WRA$outlierSEX<-ifelse(Malawi_WRA$sex==1,1,0)

Malawi_WRA$outlierAGE<-ifelse(Malawi_WRA$AGE_IN_YEARS<15| Malawi_WRA$AGE_IN_YEARS>49,1,0)
Malawi_WRA$ELIGIBLE_WOMEN<-ifelse(Malawi_WRA$outlierAGE==1|Malawi_WRA$is_pregnant==1,0,1)
Eligible <- Malawi_WRA[which(Malawi_WRA$ELIGIBLE_WOMEN==1),]

Eligible$women_agecatnew<-ifelse(Eligible$AGE_IN_YEARS>=15 & Eligible$AGE_IN_YEARS<20,1, ifelse(Eligible$AGE_IN_YEARS>=20 & Eligible$AGE_IN_YEARS<30,2, ifelse(Eligible$AGE_IN_YEARS>=30,3,0)))


#Merging with DHS dataset to obtain Wealth index and other variables 

MWIR7AFL <- read_sav("C:/Users/FannySandalinas/Documents/WP2/biomarkers/Datasets/Malawi 2015/MWIR7ASV/MWIR7AFL.SAV")

DHSDATA<-MWIR7AFL
DHSDATA<-DHSDATA %>% rename(
  survey_cluster1='V001',
  household_id1='V002',
  LINENUMBER='V003'
)

DHSDATA$WomenID<-paste(DHSDATA$survey_cluster1,DHSDATA$household_id1, DHSDATA$LINENUMBER)
Eligible$WomenID<-paste(Eligible$survey_cluster1,Eligible$household_id1, Eligible$LINENUMBER)

EligibleDHS<-merge(DHSDATA,Eligible, by='WomenID', all=TRUE)

#renaming variables coming from DHS dataset

EligibleDHS<-rename(EligibleDHS, wealth_quintile=V190)
EligibleDHS<-rename(EligibleDHS, Literacy=V155)
EligibleDHS<-rename(EligibleDHS, education_level=V106)
EligibleDHS<-rename(EligibleDHS, time_of_day_sampled2=M430H)

#for zinc, we are interested in knowing whether blood was drawn morning or afternoon, so we create a binary variable
EligibleDHS$time_of_day_sampled<-ifelse(EligibleDHS$time_of_day_sampled2<=12,'am',ifelse(EligibleDHS$time_of_day_sampled2>12,'pm','NA'))
EligibleDHS<-rename(EligibleDHS, household_id1=household_id1.x)
EligibleDHS<-rename(EligibleDHS, person_id=WomenID)
EligibleDHS<-rename(EligibleDHS, survey_weight=MWEIGHT)
EligibleDHS<-rename(EligibleDHS, is_lactating=V404)
EligibleDHS<-rename(EligibleDHS, is_smoker=V463A)
EligibleDHS<-rename(EligibleDHS, survey_strata=V022)
EligibleDHS<-rename(EligibleDHS, survey_cluster1=survey_cluster1.x)
EligibleDHS<-rename(EligibleDHS, had_fever='M416')
EligibleDHS<-rename(EligibleDHS, had_diarrhea= 'M419')
EligibleDHS<-rename(EligibleDHS,  had_malaria= 'M420')


###---Creating variables that define deficiency (although the tool will do it as well)----

#rbp
EligibleDHS$rbp_LOW<-ifelse(EligibleDHS$rbp<0.7,1,0)


#SZINC

EligibleDHS$zincDEF <-ifelse(EligibleDHS$zinc<70 & EligibleDHS$was_fasting==1 & EligibleDHS$time_of_day_sampled=='am',1,ifelse(EligibleDHS$zinc<66 &EligibleDHS$time_of_day_sampled=='am' & EligibleDHS$was_fasting==0,1,ifelse(EligibleDHS$zinc<59 & EligibleDHS$time_of_day_sampled=='pm',1,0)))

#FOLATE - 
EligibleDHS$FOLATE_DEF_WHO2012<-ifelse(EligibleDHS$ps_folate<6.8,1,0)
EligibleDHS$FOLATE_DEF_HCY<-ifelse(EligibleDHS$ps_folate<10,1,0)

EligibleDHS$RBCF_DEF_WHO2012<-ifelse(EligibleDHS$rbc_folate<226.5,1,0)
EligibleDHS$RBCF_DEF_HCY<-ifelse(EligibleDHS$rbc_folate<340,1,0)
EligibleDHS$RBCF_DEF_NTD<-ifelse(EligibleDHS$rbc_folate<906,1,0)

#VITAMIN B12
#vit b12 is is pg/mL and we want pmol/L. Need to divide by M (1355.365) and multiply by 1000.
EligibleDHS$vitamin_b12=(EligibleDHS$vitamin_b12_gr/1355.465)*1000
hist(EligibleDHS$vitamin_b12)


EligibleDHS$VITB12_SEV_DEF<-ifelse(EligibleDHS$vitamin_b12<75,1,0)
EligibleDHS$VITB12_DEF<-ifelse(EligibleDHS$vitamin_b12<150,1,0)
EligibleDHS$VITB12_DEPLETION<-ifelse(EligibleDHS$vitamin_b12<=221 & EligibleDHS$vitamin_b12>=150,1,0)

#SELENIUM
EligibleDHS$LOW_SEL_GPx3 <- ifelse(EligibleDHS$selenium<84.9,1,0)
EligibleDHS$LOW_SEL_IDI <- ifelse(EligibleDHS$selenium<64.8,1,0)
EligibleDHS$LOW_SEL_KD <- ifelse(EligibleDHS$selenium<30,1,0)

#ANEMIA
EligibleDHS$haemoglobin<-EligibleDHS$HEMOGLOBIN_LAB *10
EligibleDHS$SEVERE_ANEMIA<-ifelse(EligibleDHS$haemoglobin<79,1,0)
EligibleDHS$MODERATE_ANEMIA<-ifelse(EligibleDHS$haemoglobin>=80 & EligibleDHS$haemoglobin<109,1,0)
EligibleDHS$MILD_ANEMIA<-ifelse(EligibleDHS$haemoglobin>=110 & EligibleDHS$haemoglobin<119,1,0)

#INFLAMMATION
EligibleDHS$agp_HIGH<-ifelse(EligibleDHS$agp>1,1,0)
EligibleDHS$crp_HIGH<-ifelse(EligibleDHS$crp>5,1,0)



#giving real values to coded variables

EligibleDHS$sex<-ifelse(EligibleDHS$sex==1, 'm',ifelse(EligibleDHS$sex==2,'f', 'NA'))
EligibleDHS$urbanity<-ifelse(EligibleDHS$urbanity==1, 'urban',ifelse(EligibleDHS$urbanity==2,'rural','NA'))
EligibleDHS$urbanity<-as.character(EligibleDHS$urbanity)
EligibleDHS$is_pregnant<-as.numeric(EligibleDHS$is_pregnant)
EligibleDHS$education_level<-ifelse(EligibleDHS$education_level==0, 'none',ifelse(EligibleDHS$education_level==1,'primary',ifelse(EligibleDHS$education_level==2,'secondary',ifelse(EligibleDHS$education_level==3,'higher','NA'))))
EligibleDHS$region<-ifelse(EligibleDHS$region==1, 'North',ifelse(EligibleDHS$region==2,'Central',ifelse(EligibleDHS$region==3,'South','NA')))
EligibleDHS$Literacy<-ifelse(EligibleDHS$Literacy==1,'Able to read only parts of sentence',ifelse(EligibleDHS$Literacy==2,'Able to read whole sentence',ifelse(EligibleDHS$Literacy==3,'No card with required language',ifelse(EligibleDHS$Literacy==4,'Blind/visually impaired', ifelse(EligibleDHS$Literacy==0,'Cannot read at all',NA)))))


#adding the group ID for every observation
EligibleDHS$group_id<-ifelse(EligibleDHS$person_id>0, 'WRA')

#adding survey notes

EligibleDHS$survey_name<-ifelse(EligibleDHS$person_id>0,'Malawi Micronutrient Survey
2015-16','NA')
EligibleDHS$publication_date<-ifelse(EligibleDHS$person_id>0, 'December 2017','NA')
EligibleDHS$surveying_date_start<-ifelse(EligibleDHS$person_id>0,'December 2015','NA')
EligibleDHS$surveying_date_end<-ifelse(EligibleDHS$person_id>0,'February 2016','NA')
EligibleDHS$geometry<-ifelse(EligibleDHS$person_id>0,'National-Malawi','NA')
EligibleDHS$notes<-ifelse(EligibleDHS$person_id>0,'biomarker measurements were taken from plasma','NA')


#only keep women included in micronutrient survey
EligibleDHS2<-EligibleDHS[which(EligibleDHS$survey_weight>0),]


#only keep women who are not pregnant according to DHS (note that this is different from micronutrient survey and might explain some discrepancies in number with the published report)
EligibleDHS2$pregnantDHS<-ifelse(EligibleDHS2$V213==1,1,0)
EligibleDHS2$pregnantDHS<-ifelse(is.na(EligibleDHS2$V213),0,EligibleDHS2$V213)
EligibleDHS2<-EligibleDHS2[which(EligibleDHS2$pregnantDHS==0),]


#imputing some variables that were lost during the merging
EligibleDHS2$survey_cluster<-ifelse(is.na(EligibleDHS2$survey_cluster1), EligibleDHS2$survey_cluster1.y, EligibleDHS2$survey_cluster1)

EligibleDHS2$household_id<-ifelse(is.na(EligibleDHS2$household_id1), EligibleDHS2$household_id1.y, EligibleDHS2$household_id1)


EligibleDHS<-EligibleDHS2


#data cleaning (case by case -> to adapt to each survey)

# changing sex to f as it seems like a typo
EligibleDHS$sex<-ifelse(EligibleDHS$sex=='m','f',EligibleDHS$sex)

#keeping only 2 values + NA for malaria variable
EligibleDHS$Malaria_test_result<-ifelse(EligibleDHS$Malaria_test_result==3|EligibleDHS$Malaria_test_result==4|EligibleDHS$Malaria_test_result==6,'NA', ifelse(EligibleDHS$Malaria_test_result==2,0,EligibleDHS$Malaria_test_result))


#changing values to 0 (no) and 1 (yes) as this is how we define binary variables
EligibleDHS$had_fever<-ifelse(EligibleDHS$had_fever==2,0, ifelse(EligibleDHS$Malaria_test_result==1,1,NA))

EligibleDHS$had_diarrhea<-ifelse(EligibleDHS$had_diarrhea==2,0, ifelse(EligibleDHS$had_diarrhea==1,1,NA))

EligibleDHS$had_malaria<-ifelse(EligibleDHS$had_malaria==2,0, ifelse(EligibleDHS$had_malaria==1,1,NA))



#some people were not included in DHS questionnaire and data are missing. For wealth quintiles, we can impute the value of other people living in the same household. Same for strata values
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='114 283 1', '5',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='23 68 5', '3',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='342 15 2', '2',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='37 70 3', '5',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='37 70 6', '5',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='468 147 1', '4',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='5 4 3', '1',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='511 257 3', '2',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='720 267 4', '3',EligibleDHS$wealth_quintile)
EligibleDHS$wealth_quintile<-ifelse(EligibleDHS$person_id=='720 267 4', '3',EligibleDHS$wealth_quintile)

EligibleDHS$survey_strata<-ifelse(EligibleDHS$survey_cluster==114,8,
                                  ifelse(EligibleDHS$survey_cluster==140,1,
                                  ifelse(EligibleDHS$survey_cluster==190,40, 
                                  ifelse(EligibleDHS$survey_cluster==23,31, 
                                  ifelse(EligibleDHS$survey_cluster==294,23, 
                                  ifelse(EligibleDHS$survey_cluster==303,53,   
                                  ifelse(EligibleDHS$survey_cluster==309,4,                                                                                ifelse(EligibleDHS$survey_cluster==342,5,
                                  ifelse(EligibleDHS$survey_cluster==37,10, 
                                  ifelse(EligibleDHS$survey_cluster==377,29, 
                                  ifelse(EligibleDHS$survey_cluster==410,33,
                                  ifelse(EligibleDHS$survey_cluster==468,47,
                                  ifelse(EligibleDHS$survey_cluster==5,25,  
                                  ifelse(EligibleDHS$survey_cluster==511,27,
                                  ifelse(EligibleDHS$survey_cluster==566,33, 
                                  ifelse(EligibleDHS$survey_cluster==571,5,
                                  ifelse(EligibleDHS$survey_cluster==601,29,
                                  ifelse(EligibleDHS$survey_cluster==676,10, 
                                  ifelse(EligibleDHS$survey_cluster==720,41,
                                  EligibleDHS$survey_strata)))))))))))))))))))



#deleting negative value of iodine
EligibleDHS$iodine<-ifelse(EligibleDHS$iodine<0,NA,EligibleDHS$iodine)

#checking how many variables are outside the plausible values. for some of them, when it's documented in the literature or really implausible, we are changing to NA - best to do case by case and check before removing any value

count(EligibleDHS$ferritin<0, na.rm=TRUE)
count(EligibleDHS$ferritin>9999, na.rm=TRUE)
count(EligibleDHS$ferritin==0)
EligibleDHS$ferritin<-ifelse(EligibleDHS$ferritin>9999,NA,EligibleDHS$ferritin)

count(EligibleDHS$stfr>40, na.rm=TRUE)
count(EligibleDHS$stfr==0)
EligibleDHS$stfr<-ifelse(EligibleDHS$stfr>199,NA,EligibleDHS$stfr)

count(EligibleDHS$retinol==0)
count(EligibleDHS$retinol>3, na.rm=TRUE)
EligibleDHS$retinol<-ifelse(EligibleDHS$retinol>20,NA,EligibleDHS$retinol)

#this one is documented with IZINC
count(EligibleDHS$zinc==0)
count(EligibleDHS$zinc>161, na.rm=TRUE)
EligibleDHS$zinc<-ifelse(EligibleDHS$zinc>161,NA,EligibleDHS$zinc)

count(EligibleDHS$vitamin_b12==0)
count(EligibleDHS$vitamin_b12>9999, na.rm=TRUE)
EligibleDHS$vitamin_b12<-ifelse(EligibleDHS$vitamin_b12>9999,NA,EligibleDHS$vitamin_b12)

count(EligibleDHS$iodine==0)
count(EligibleDHS$iodine>1999, na.rm=TRUE)
EligibleDHS$iodine<-ifelse(EligibleDHS$iodine>1999,NA,EligibleDHS$iodine)

count(EligibleDHS$rbc_folate==0)
count(EligibleDHS$rbc_folate>9999, na.rm=TRUE)
EligibleDHS$rbc_folate<-ifelse(EligibleDHS$rbc_folate>9999,NA,EligibleDHS$rbc_folate)

count(EligibleDHS$s_folate==0)
count(EligibleDHS$ps_folate>100, na.rm=TRUE)
EligibleDHS$ps_folate<-ifelse(EligibleDHS$ps_folate>1000,NA,EligibleDHS$ps_folate)

count(EligibleDHS$crp>100, na.rm=TRUE)
count(EligibleDHS$agp>5, na.rm=TRUE)

#changing unit of haemoglobin
EligibleDHS$haemoglobin<-EligibleDHS$haemoglobin/10

#this is documented in the literature as well (see notes)
count(EligibleDHS$haemoglobin<4, na.rm=TRUE)
count(EligibleDHS$haemoglobin>18, na.rm=TRUE)
EligibleDHS$haemoglobin<-ifelse(EligibleDHS$haemoglobin>18,NA,EligibleDHS$haemoglobin)
EligibleDHS$haemoglobin<-ifelse(EligibleDHS$haemoglobin<4,NA,EligibleDHS$haemoglobin)

#we could either exclude on the basis of BMI z score or implausible values of height and weight. For children we use z score as there is more variation. for adults, we use individual values as we only need to delete either weight or height (and not both like for children)
count(EligibleDHS$WEIGHT>200, na.rm=TRUE)
count(EligibleDHS$WEIGHT<20, na.rm=TRUE)
count(EligibleDHS$HEIGHT<100, na.rm=TRUE)
count(EligibleDHS$HEIGHT>250, na.rm=TRUE)
EligibleDHS$WEIGHT<-ifelse(EligibleDHS$WEIGHT<20,NA,EligibleDHS$WEIGHT)
EligibleDHS$WEIGHT<-ifelse(EligibleDHS$WEIGHT>200,NA,EligibleDHS$WEIGHT)
EligibleDHS$HEIGHT<-ifelse(EligibleDHS$HEIGHT<100,NA,EligibleDHS$HEIGHT)
EligibleDHS$HEIGHT<-ifelse(EligibleDHS$HEIGHT>250,NA,EligibleDHS$HEIGHT)
EligibleDHS$BMI<- EligibleDHS$WEIGHT/(EligibleDHS$HEIGHT/100)^2


EligibleDHS$time_of_day_sampled<-ifelse(EligibleDHS$time_of_day_sampled==1,'am', ifelse(EligibleDHS$time_of_day_sampled==2,'pm','NA'))


#keeping only a certain number of digits

EligibleDHS$ferritin <-as.numeric(EligibleDHS$ferritin)
EligibleDHS$stfr <-as.numeric(EligibleDHS$stfr)

EligibleDHS$WEIGHT<-as.numeric(EligibleDHS$WEIGHT)
EligibleDHS$HEIGHT<-as.numeric(EligibleDHS$HEIGHT)
EligibleDHS$zinc<-as.numeric(EligibleDHS$zinc)
EligibleDHS$haemoglobin<-as.numeric(EligibleDHS$haemoglobin)
EligibleDHS$ps_folate<-as.numeric(EligibleDHS$ps_folate)
EligibleDHS$retinol<-as.numeric(EligibleDHS$retinol)

EligibleDHS$ferritin<-format(round(EligibleDHS$ferritin,2))
EligibleDHS$stfr<-format(round(EligibleDHS$stfr,2))
EligibleDHS$zinc<-format(round(EligibleDHS$zinc,2))
EligibleDHS$vitamin_b12<-format(round(EligibleDHS$vitamin_b12,1))
EligibleDHS$crp<-format(round(EligibleDHS$crp,2))
EligibleDHS$agp<-format(round(EligibleDHS$agp,2))
EligibleDHS$rbc_folate<-format(round(EligibleDHS$rbc_folate,2))
EligibleDHS$retinol<-format(round(EligibleDHS$retinol,2))
EligibleDHS$haemoglobin <-format(round(EligibleDHS$haemoglobin,2))
EligibleDHS$WEIGHT<-format(round(EligibleDHS$WEIGHT,1))
EligibleDHS$HEIGHT<-format(round(EligibleDHS$HEIGHT,1))
EligibleDHS$ps_folate<-format(round(EligibleDHS$ps_folate,2))
EligibleDHS$iodine<-format(round(EligibleDHS$iodine,2))
EligibleDHS$selenium<-format(round(EligibleDHS$selenium,2))
EligibleDHS$retinol<-as.numeric(EligibleDHS$retinol)
EligibleDHS$retinol<-format(round(EligibleDHS$retinol,2))

EligibleDHS$BMI<-format(round(EligibleDHS$BMI,1))

EligibleDHS$ferritin<-as.numeric(EligibleDHS$ferritin)
EligibleDHS$stfr<-as.numeric(EligibleDHS$stfr)
EligibleDHS$zinc<-as.numeric(EligibleDHS$zinc)
EligibleDHS$vitamin_b12<-as.numeric(EligibleDHS$vitamin_b12)
EligibleDHS$crp<-as.numeric(EligibleDHS$crp)
EligibleDHS$agp<-as.numeric(EligibleDHS$agp)
EligibleDHS$rbc_folate<-as.numeric(EligibleDHS$rbc_folate)
EligibleDHS$retinol<-as.numeric(EligibleDHS$retinol)
EligibleDHS$haemoglobin<-as.numeric(EligibleDHS$haemoglobin)
EligibleDHS$WEIGHT<-as.numeric(EligibleDHS$WEIGHT)
EligibleDHS$HEIGHT<-as.numeric(EligibleDHS$HEIGHT)
EligibleDHS$ps_folate<-as.numeric(EligibleDHS$ps_folate)
EligibleDHS$iodine<-as.numeric(EligibleDHS$iodine)
EligibleDHS$BMI<-as.numeric(EligibleDHS$BMI)



#other checks
#checking unique ID
length(unique(EligibleDHS$person_id))
length(unique(EligibleDHS$person_id)) == nrow(EligibleDHS)

#rename to include units

EligibleDHS<-rename(EligibleDHS, weight_in_kg=WEIGHT)
EligibleDHS<-rename(EligibleDHS, height_in_cm=HEIGHT)

#Adding file notes on the first observation

EligibleDHS$file_notes<-ifelse(EligibleDHS$person_id=='101 116 2','1 negative value of iodine was excluded from the analysis.
7 values of zinc were excluded as considered implausible. (ref: IZINC technical brief. Adjusting plasma or serum zinc concentrations for inflammation. 2020). 3 values of weight superior to 200 kilos were excluded. 6 values of height superior to 250 cm were excluded',' ')


EligibleDHS$created_by<-ifelse(EligibleDHS$person_id=='101 116 2','FannySandalinas',' ')


EligibleDHS$created_date<-ifelse(EligibleDHS$person_id=='101 116 2','12oct2021',' ')


#add GPS values

GPS<-read.csv("C:/Users/FannySandalinas/OneDrive - London School of Hygiene and Tropical Medicine/MAPSFanny/MalawiGPS.csv")

GPS<-rename(GPS, survey_cluster='DHSCLUST')

EligibleDHS<- merge(EligibleDHS, GPS, by='survey_cluster' )

EligibleDHS<-rename(EligibleDHS, latitude='LATNUM')
EligibleDHS<-rename(EligibleDHS, longitude='LONGNUM')
EligibleDHS<-rename(EligibleDHS, altitude_in_metres='ALT_GPS')



EXPORTDATA<-subset(EligibleDHS, select = c('household_id','group_id','sex','person_id','age_in_months','education_level','is_lactating','is_pregnant','is_smoker','had_fever','had_diarrhea','had_malaria','survey_cluster','survey_strata','survey_weight','urbanity','region','Literacy', 'ferritin','stfr','zinc','rbp','time_of_day_sampled','vitamin_b12','crp', 'agp','selenium', 'rbc_folate','retinol','haemoglobin','Malaria_test_result','weight_in_kg','height_in_cm','was_fasting','ps_folate','iodine','wealth_quintile','latitude','longitude','altitude_in_metres','survey_name','publication_date','surveying_date_start','surveying_date_end','geometry','notes','file_notes','created_by','created_date'))


write.csv(EXPORTDATA, 'exportMalawiWRA.csv')

#exporting some household data to merge with men dataset

EligibleDHS$household_cid<-paste(EligibleDHS$survey_cluster, EligibleDHS$household_id)

RECOMA<-subset(EligibleDHS, select=c('household_cid', 'wealth_quintile','survey_strata','education_level'))
write.csv(RECOMA, 'recoma.csv')


```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
