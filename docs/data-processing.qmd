

## Methods: Data processing

Once the datasets are selected and cleaned. The next step is preparing the variables that are going to be used in the model. Particularly, generating the different estimates of maize grain Se concentration and predicted Se concentration for each aggregation level that will be compared with the plasma Se concentration in Malawian women. 


```{r set-up, message=FALSE, warning=FALSE}

# Loading packages
library(dplyr) # data wrangling 
library(sf) # spatial data manipulation
library(tmap) # spatial data visualisation

# Loading data
# Admin Boundaries for Malawi: EAs
ea_bnd  <- st_read(here::here("data", "mwi-boundaries", "EN_NSO" , "eas_bnd.shp"), quiet = TRUE)

# Admin boundaries w/o Lake
# Selecting only variables that are interesting:
  # EA code, EA area, TA code, district & geometry
ea_admin <- ea_bnd %>% filter(!grepl("lake", DISTRICT, ignore.case = TRUE)) %>% 
  select(c(4, 10, 11, 17, 18))

# Maize Se conc.(from cleaned from 00_cleaning-maize.R)
maize.df<- readRDS(here::here("data", "inter-output", "mwi-grain-se_raw.RDS")) %>%
   ## Getting only entries with maize Se values
  filter(!is.na(Se_raw) & Crop == "Maize")

# Plasma Se conc. (cleaned from 00_cleaning-dhs.R)
plasma.df  <- readRDS(here::here("data", "inter-output","dhs_se_gps.rds")) %>% 
  # removing entries with missing values in plasma Se conc.
 filter(!is.na(selenium))


```


The datasets that we used are listed below:

-   `ea_admin`: This (shape)file contains the boundaries of Malawi smallest administrative units, Enumeration Areas (EAs), and information on their corresponding districts and regions. Note that the boundaries of the lakes (e.g., Lake Malawi) were excluded as maize grain nor plasma Se could have been taken within those boundaries. 

-   `maize.df`: This file contains the GPS sample location (lat/lon), maize grain Se concentration, soil pH and Mean Annual Temperature (MAT). See section XX for more information on the dataset.

-   `plasma.df`: This file contains the displaced [cluster location](#gps-location) (lon/lat), plasma Se concentration, and other individual level information (wealth quintile, BMI, etc.). See {@se-biomarker-dataset-dhs-mns} for more information on the dataset.

## Generating predicted maize grain Se concentration for Malawi

-`predmaize.df`: This file contains the coordinates of Malawi (lat/lon), the predicted maize Se concentration for Malawi and their covariance (uncertainty associated to each prediction). The data was derived from the `maize.df` dataset using ordinary kriging and the scripts can be found in `01_maize-model.R` and are based on the study of Gashu and colleagues (2022).


**TODO: Write the full info of the model**


Then, in order to calculate the mean/median value for each level of aggregation first, we need to generate the boundaries that will be used. 


## Generating the boundaries

The first two aggregations (areal units) were based on administrative boundaries (e.g., EAs, districts) whereas the other two aggregation levels were based on the cluster location. 

### Administrative boundaries areas

#### Enumeration Areas of the observed maize grain Se dataset

In our maize grain Se dataset, we do not have information about the administrative boundaries where each sample point lies in. Therefore, in order to calculate the mean/media maize Se concentration for each administrative unit, we need to link the dataset with the administrative boundaries of Malawi (`ea_admin`) with the maize grain Se dataset (`maize.df`).

The first step is to identify the EAs where each maize grain were sampled. We started with the EAs because are the smallest administrative units, and they are nested within the other (bigger) administrative units (Districts and Regions). 

To do so, we need to spatially merge the boundaries dataset (`ea_admin`) and the maize Se dataset. Hence, some data preparation need to be done before carrying the spatial join. For instance, both datasets need to be spatial objects. 


```{r}

# Checking the class of the two datasets
class(ea_admin)
class(maize.df)


```

We can see that the maize grain dataset is not a spatial object. Therefore, we need to use the `sf package`. 

```{r}

# Transforming maize data.frame into a spatial object (geometry) 
geomaize.df <- st_as_sf(maize.df,
              coords =c("Longitude", "Latitude"), crs = "EPSG:4326")

# Checking the effect of the line above
class(geomaize.df)

# Adding a variable to store info on distance 
geomaize.df$dist_in_m <- NA


```

Then, we can merge the two dataset. 

```{r}

# Getting info on the admin boundaries (EA/district level)
# Allocating Se values to each admin unit
geomaize_ea.df  <-  st_join(geomaize.df, ea_admin)

```


There were some maize grain samples (n=`r sum(is.na(geomaize_ea.df$EACODE))`) without a corresponding EA. This was because some of the GPS location were incorrect/inaccurate (i.e., one sample location lied outside Malawi boundaries), or due to lying in outside boundaries as it is shown in the map below by the red dots (@fig-map1). 


```{r label = "fig-map1", fig.cap = "Map of Malawi divided by Enumeration Areas (EAs) and the red points representing the maize grain Se samples outside EA boundaries."}

# Storing data of the maize Se samples w/o EAs
missing  <- geomaize_ea.df[which(is.na(geomaize_ea.df$EACODE)),]

# Plotting maize Se sample falling out EAs
tm_shape(ea_bnd) +
tm_polygons() +
tm_shape(missing) +
tm_symbols(col ="red", size =0.1)

```

Instead of removing the observations, we decided to allocated them to the closest EA (in m). The information on how far (in m) were from the EA that were allocated too, was also stored in the new variable that was generated in previous steps: `dist_in_m`.

```{r}

# Fixing missing (EAs for maize Se values) 
m <-  c(90, 200, 300, 4500)

for(i in 1:length(m)){

geomaize_ea.df[which(is.na(geomaize_ea.df$EACODE)), "dist_in_m"] <- m[i]
  
geomaize_ea.df[which(is.na(geomaize_ea.df$EACODE)),]  <-  st_join(geomaize_ea.df[which(is.na(geomaize_ea.df$EACODE)),1:ncol(geomaize.df)-1], 
    ea_admin, st_is_within_distance,  dist = units::set_units(m[i], "m")) 

}


```

Once each sample of maize grain was allocated to their respective EAs and districts, we wanted to know which they were in. This variable was created using the information stored in the EA code, as each `EACODE` starting number is corresponding to the region which they belong to.


```{r}

# Adding a variable for region (1>3 = N>S)
geomaize_ea.df$region  <-  NA
geomaize_ea.df$region[grepl("^1", geomaize_ea.df$EACODE)]  <- "1"
geomaize_ea.df$region[grepl("^2", geomaize_ea.df$EACODE)]  <- "2"
geomaize_ea.df$region[grepl("^3", geomaize_ea.df$EACODE)]  <- "3"

```

Finally, the maize grain dataset was ready for calculating the mean/median Se concentration at the different administrative boundaries and was stored into as intermediary output for further analysis. Before saving the dataset, it was transformed back into a data frame by removing the `geometry` and adding back the information about the samples locations as coordinates (`longitude` and `latitude`).

```{r eval=FALSE}

# Converting back from spatial obj to dataframe
maize.df  <- geomaize_ea.df  %>% st_drop_geometry()  %>%  #removing geometry
            right_join(., maize.df)  # adding back the long/lat variable

# Saving dataset with aggregation unit for modelling 
saveRDS(maize.df, here::here("data", "inter-output",
                             "mwi_maize-se-raw_admin.RDS"))

```


#### Enumeration Areas of the household locations 
 
Similarly, in the plasma dataset, the EAs were not available for each household. In addition, due to confidentiality and anonymity protection, household locations are not available. Instead, the displaced GPS location of each cluster (i.e., EA) is provided. This means that the population centroid of each cluster was register in the original survey, and then displaced within 2km for urban clusters and 5km for rural clusters, with 10% of the rural clusters displaced within 10km buffer. Therefore, it is often not advised to used and/or link this type of data to distance-based measurement and/or small areas where high risk of missclassification may exist. This is because the location of the households could be in any of the EAs within the displaced buffer area. 

Hence, we decided to use the buffer areas instead of the point locations (GPS coordinates) to standardise/ minimise the measurement error from the off-setting of the coordinates, and in turn, use the buffer area to identify the probable EAs where the households may be located. 

```{r}

# Getting only cluster location (to avoid duplicates), 
geodata.df <- plasma.df %>% select(survey_cluster1, buffer) %>% 
  distinct() %>% 
# renaming buffer as geometry for converting into spatial object
  dplyr::rename(geometry = "buffer") %>% st_sf(., crs = "EPSG:4326")

```

To do so, we used the spatial join to identify the Malawi EAs (`ea_admin`) within the buffered areas for each cluster.

```{r}

# Getting info on the admin boundaries (EA/district level)
# Allocating buffered areas to each admin unit

geodata_ea <-  st_join(geodata.df, ea_admin)

```

In the @fig-map2, we can see, in dark red, the EAs that were within the buffered areas, and in blue the buffers. 

```{r label = "fig-map2", fig.cap = "Map of Malawi with the possible EAs where the household that were surveyed in the DHS-MNS may reside (in dark red), and the buffer representing the GPS displacement (in blue).", fig.height=7, fig.width=6}

# Aggregate boundaries the whole country (with lakes)
malawi_bnd_lakes <- st_union(ea_bnd)

# Aggregate boundaries the whole country
malawi_bnd <- st_union(ea_admin)

# Generating the map
tm_shape(ea_admin) +
  tm_polygons(col = "white", 
              border.col = "#666666", border.alpha = 0.3, lwd = 0.2) +
tm_shape(malawi_bnd) +
  tm_borders(col = "#666666", alpha = 0.6, lwd = 0.5) +
  tm_shape(malawi_bnd_lakes) +
  tm_borders(col = "black", alpha = 0.6, lwd = 0.5) +
    tm_shape(ea_admin$geometry[ea_admin$EACODE %in% unique(geodata_ea$EACODE)]) +
  tm_polygons(col ="firebrick4", border.col = "black", border.alpha = 0.3) +
  tm_shape(geodata.df) +
  tm_borders(col = "steelblue" )

```

When we checked the EAs that were included in each cluster, we realised that there were some clusters that were very close to the district boundaries, thus including some EAs from different district. According to the DHS documentation, displacement was performed to respect district boundaries, hence households will be within their district (see district information on DHS dataset) and because here we are looking at administrative boundaries, we need to remove the EAs that did not below to the district for each cluster. However, there were some cluster without district information.

Review the two datasets in the DHS to see, if any of the two have the information on the district, if they don't, then we may need to think of a different approach, that could be:
  
  a) the highest mass within the buffered area
  b) the highest number of EAs w/i each buffer and district
  





```{r}

```

### Household location-based areas (buffer) 

For the household-based areas, ideally, we would like to test the aggregation of the maize grain Se as function of the distance from each household. For instance, with buffered areas around the household, that could be identified as "food-sheds" or "food catchment areas". However, as explained in previous section, the location used to generate the buffer are not the real household location but an approximation. By generating bigger than the displacement area buffer we aim to capture the plausible "food catchment area" for each WRA in the sample. 

Two buffer distances selected were:

1) **10km buffer** to cover the max displacement in rural area for the GPS location of the DHS clusters, and,

2) **20-30km buffer** that cover a sensible distance between EAs and district, and which is according to REF, the mean distance between households and the closest market in Malawi (REF). 

For identifying the EA centroids we used the EAs with maize sampling sites were used to generate the buffers.

##### Buffered areas based on the maize sampling sites

The centroid of the EAs with maize sampling sites were used to generate the buffers, which was based on the assumption that the maize Se coordinates (with no offset) were the correct EAs on the assumption that all the EAs where the MNS was carried out were sampled in the GeoNutrition study (@ref-Gashu). In addition, because maize samples were not collected in all EAs, and we are not predicting maize Se values, the EAs with maize Se values would be driving the location. 

### Co-location: combining datasets by location

Samples, both maize and plasma, were supposed to be co-located (i.e., collected at the same EA) as per documentation on Gashu et al, (2021). However, when we checked the co-location of the two datasets: plasma Se values and the maize Se, based on the EAs where they were collected/ reported around 60% of our sample did not share the same EA. This was probably  due to the EA displacement performed within the DHS protocol (see XX). 

Hence, we decided to use the EAs where maize sample were collected (at the were not displaced), and to co-locate (by closest distance possible) the EAs within the buffer area displaced (2km and 5km for urban and rural respectively). 

Even when doing that, there were still two clusters (group of EAs) that did not have any maize grain Se value co-location. For those clusters, the closest EA (xx m) with maize grain Se values were used. 

#### Limitations of the co-location

This "co-location" issues were only problematinc at the smallest area tested (e.g., cluster level) and for observed mean/median (that calculated using only sampled (observed/analytical) values). Hence, the concern when comparing with the predicted surface will be:

**What are we really measuring/ comparing?**

We want to know whether: 


a)  Does observed estimates provides better prediction/ explanation of the plasma Se than predicted surfaces? 


b)  At what level of data aggregation we can see better explanation of the plasma Se values? 

Re: Does this mean that I should use the predicted surface of the same EAs as of the observed, regardless that I could actually use the mean of the same EAs as reported in the DHS cluster?

  --> Sensitivity analysis: Compare predicted surface mean/ median of the actual cluster (aggregated EA) values with the same EA only of the observed values (i.e., replicating the same area of the observed values). To see if the results of our analysis are actually measuring methodological differences (i.e., between normal aggragated mean and predicted surface), or on the contrary are picking spatial variation in maize Se values (i.e., there is a difference between picking the nearest EAs and peaking the "actual" EAs). 




#### Testing assumptions

##### Displaced location EAs

We studied the distance between EA (based on the displaced GPS location) with plasma Se values, and the maize Se EAs. To do so, we added the distance (in m) at which the co-location was found, when we studied the distance for rural clusters, we can see that only one cluster, corresponding to n=8 WRA reported location, were within higher distance (>5km) of the displacement. This corresponded to 1.23% of the sample of rural household which is below the reported, 10% displacement of 10km.

##### Most probable EA

Following the guidelines on the use of DHS GPS data, (@perez2013guidelines), we assumed the missclassification potential, then we:

- identify the most probable EA
- compared that with the results above, i.e.,  with EAs were the same and which one were different
- checked for those most probable which one had maize Se conc. and which one not 

The list of the EAs where the WRA potentially lived was obtained in the scripts (00_cleaning-locations.R), and it was used to generate the centroids and buffers for further modelling in the 00_cleaning-boundaries.R.